<!-- <!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
	<meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
	<script type="module" src="js/main.js" async></script>
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/audio-info.css">
	<link rel="stylesheet" href="css/all.min.css">
</head>
<body>
	<h1>Audiophile</h1>
	<div class="audio-info-container">
			<div class="audio-artwork">
				<span>ðŸŽµ</span>
			</div>
			<div class="audio-title">Blinding Lights</div>
			<div class="audio-artist">The Weeknd</div>
			<div class="audio-details">
				<span>Album: After Hours</span>
				<span>2020</span>
			</div>
			<canvas id="waveform-canvas" width="340" height="80" class="audio-waveform"></canvas>
			<div class="audio-progress">
				<div class="audio-progress-bar" style="width: 40%"></div>
			</div>
			<div class="audio-details">
				<span>1:12</span>
				<span>3:20</span>
			</div>

	</div>
	<div class="audio-controls">
		<div class="fa-solid fa-circle-play audio-play-btn"></div>
		<div class="fa-solid fa-file-arrow-down audio-download-btn"></div> 
	</div>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Float32Array â†’ AAC</title>
</head>
<body>
<button id="recordBtn">Convert Float32Array to AAC</button>

<script>
/**
 * Step 1: Detect AAC support
 */
function getSupportedAACMimeType() {
    const types = [
        'audio/mp4; codecs="mp4a.40.2"', // AAC-LC
        'audio/aac',
        'audio/mp4'
    ];
    for (const type of types) {
        if (MediaRecorder.isTypeSupported(type)) return type;
    }
    return null;
}

/**
 * Step 2: Convert Float32Array to AudioBuffer
 */
function float32ToAudioBuffer(float32Array, sampleRate = 44100, channels = 1) {
    const audioCtx = new AudioContext({ sampleRate });
    const buffer = audioCtx.createBuffer(channels, float32Array.length, sampleRate);
    for (let ch = 0; ch < channels; ch++) {
        buffer.copyToChannel(float32Array, ch);
    }
    return { audioCtx, buffer };
}

/**
 * Step 3: Route AudioBuffer to MediaStream
 */
function bufferToMediaStream(audioCtx, audioBuffer) {
    const source = audioCtx.createBufferSource();
    source.buffer = audioBuffer;

    const destination = audioCtx.createMediaStreamDestination();
    source.connect(destination);
    source.start();

    return { source, destination };
}

/**
 * Step 4: Record AudioBuffer as AAC
 */
async function float32ToAAC(float32Array, sampleRate = 44100, channels = 1) {
    const mimeType = getSupportedAACMimeType();
    if (!mimeType) throw new Error("AAC not supported in this browser");

    const { audioCtx, buffer } = float32ToAudioBuffer(float32Array, sampleRate, channels);
    const { destination } = bufferToMediaStream(audioCtx, buffer);

    const recorder = new MediaRecorder(destination.stream, { mimeType });
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.start();

    // Stop recording after buffer duration
    await new Promise(resolve => setTimeout(resolve, (buffer.duration + 0.1) * 1000));
    recorder.stop();

    return new Promise(resolve => {
        recorder.onstop = () => {
            const blob = new Blob(chunks, { type: mimeType });
            resolve(blob);
        };
    });
}

/**
 * Step 5: Example usage
 */
document.getElementById('recordBtn').addEventListener('click', async () => {
    // Example: 2 seconds of silence, mono
    const sampleRate = 44100;
    const duration = 2; // seconds
    const float32Array = new Float32Array(sampleRate * duration).fill(0);

    try {
        const aacBlob = await float32ToAAC(float32Array, sampleRate, 1);
        const url = URL.createObjectURL(aacBlob);

        const a = document.createElement('a');
        a.href = url;
        a.download = 'output.aac'; // actually AAC in MP4 container or Opus fallback
        a.click();

        // Revoke URL after download
        setTimeout(() => URL.revokeObjectURL(url), 5000);
    } catch (err) {
        console.error("Error converting Float32Array to AAC:", err);
    }
});
</script>
</body>
</html>
